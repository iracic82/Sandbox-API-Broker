# Quick Start Guide - Sandbox Broker API

## üöÄ Run a Test Allocation

### 1. Get Your API Token
```bash
export BROKER_API_TOKEN=$(aws secretsmanager get-secret-value \
  --secret-id sandbox-broker-broker-api-token-20251004124001695200000001 \
  --region eu-central-1 --profile okta-sso \
  --query SecretString --output text)
```

### 2. Run the Test Script
```bash
cd examples
./test_allocation.sh
```

## üì¶ What You Get

The allocation script creates **4 files** in your current directory:

### 1. `sandbox_id.txt` - Broker Internal ID
```
2012244
```
This is the broker's internal identifier for the sandbox. Use it to mark the sandbox for deletion.

### 2. `external_id.txt` - CSP UUID (THE IMPORTANT ONE!)
```
8ce6e4ed-ec1f-40f4-8340-91f20f4d26aa
```
**This is the CSP account ID you use to connect to the sandbox!**

Example usage with Infoblox CSP API:
```bash
CSP_ACCOUNT_ID=$(cat external_id.txt)

curl https://csp.infoblox.com/api/ddi/v1/ipam/address \
  -H "Authorization: Token ${INFOBLOX_TOKEN}" \
  -H "X-Account-ID: ${CSP_ACCOUNT_ID}"
```

### 3. `sandbox_name.txt` - CSP Tenant Name
```
yfu3kuhgesdm
```
Human-readable tenant name in CSP (e.g., "yfu3kuhgesdm", "test-3", "sandbox-42").

### 4. `sandbox_env.sh` - Environment Variables (Ready to Source!)
```bash
#!/bin/bash
# Auto-generated by instruqt_broker_allocation.py
export STUDENT_TENANT=yfu3kuhgesdm
export CSP_ACCOUNT_ID=8ce6e4ed-ec1f-40f4-8340-91f20f4d26aa
export SANDBOX_ID=2012244
```

**Usage:**
```bash
# In bash scripts
source sandbox_env.sh
echo "Using tenant: $STUDENT_TENANT"
echo "CSP Account ID: $CSP_ACCOUNT_ID"

# In Instruqt (persists across steps)
set-var STUDENT_TENANT $(cat sandbox_name.txt)
set-var CSP_ACCOUNT_ID $(cat external_id.txt)
set-var SANDBOX_ID $(cat sandbox_id.txt)
```

## üìã Complete Example Output

```bash
üß™ Testing Sandbox Broker Allocation
====================================

üìã Configuration:
   API URL: https://api-sandbox-broker.highvelocitynetworking.com/v1
   Student ID: test-student-1759743926-2766
   Lab: test-lab-run

üöÄ Running allocation...
üéì Student: test-student-1759743926-2766
üìö Lab: test-lab-run
üîÑ Allocation attempt 1/5...
‚úÖ Sandbox allocated (HTTP 201)
‚úÖ Sandbox ID saved to sandbox_id.txt: 2012244
‚úÖ External ID saved to external_id.txt: 8ce6e4ed-ec1f-40f4-8340-91f20f4d26aa
‚úÖ Sandbox name saved to sandbox_name.txt: yfu3kuhgesdm

üí° To use these variables in bash:
   source sandbox_env.sh

   Or for Instruqt (persists across steps):
   set-var STUDENT_TENANT yfu3kuhgesdm
   set-var CSP_ACCOUNT_ID 8ce6e4ed-ec1f-40f4-8340-91f20f4d26aa

============================================================
üéâ Sandbox Allocation Complete!
   Name: yfu3kuhgesdm
   Sandbox ID: 2012244
   External ID: 8ce6e4ed-ec1f-40f4-8340-91f20f4d26aa (use this to connect to CSP)
   Expires: 2025-10-06 13:45:31 UTC
============================================================
```

## üßπ Cleanup

When the student finishes the lab:

```bash
export BROKER_API_TOKEN="<your_token>"
export INSTRUQT_PARTICIPANT_ID="test-student-1759743926-2766"

python3 instruqt_broker_cleanup.py
```

This marks the sandbox for deletion. The background cleanup job will delete it from CSP within ~5 minutes.

## üîç Verify Allocation

Check the sandbox status via API:
```bash
curl https://api-sandbox-broker.highvelocitynetworking.com/v1/sandboxes/2012244 \
  -H "Authorization: Bearer ${BROKER_API_TOKEN}" \
  -H "X-Instruqt-Sandbox-ID: test-student-1759743926-2766" | jq
```

Expected response:
```json
{
  "sandbox_id": "2012244",
  "name": "yfu3kuhgesdm",
  "external_id": "8ce6e4ed-ec1f-40f4-8340-91f20f4d26aa",
  "status": "allocated",
  "allocated_to_track": "test-student-1759743926-2766",
  "allocated_at": 1759743931,
  "expires_at": 1759758331,
  "track_name": "test-lab-run"
}
```

## üìö Key Concepts

### Idempotency
If you call the allocation API with the same `INSTRUQT_PARTICIPANT_ID` multiple times, you get the **same sandbox back** (HTTP 200 instead of 201). This prevents double-allocations.

### Multi-Student Support
Multiple students can run the same lab simultaneously:
- Each student has unique `INSTRUQT_PARTICIPANT_ID` ‚Üí Different sandbox
- All students share same `INSTRUQT_TRACK_SLUG` ‚Üí Same lab

### Name Filtering (Optional)
Filter which sandboxes can be allocated:
```bash
export SANDBOX_NAME_PREFIX="lab-adventure"
python3 instruqt_broker_allocation.py
# Only allocates sandboxes starting with "lab-adventure"
```

## üÜò Troubleshooting

**Pool Exhausted (HTTP 409)**:
```json
{
  "detail": {
    "code": "NO_SANDBOXES_AVAILABLE",
    "message": "No available sandboxes in pool"
  }
}
```
‚Üí Contact admin to provision more sandboxes or wait for students to finish

**Rate Limited (HTTP 403)**:
‚Üí WAF protection triggered (2000 req/5min per IP). Script will auto-retry.

**Token Error (HTTP 401)**:
‚Üí Check `BROKER_API_TOKEN` is set correctly

## üìñ Full Documentation

- **API Docs**: https://api-sandbox-broker.highvelocitynetworking.com/v1/docs
- **README**: [README.md](README.md)
- **Project README**: [../README.md](../README.md)

---

**Happy Testing! üéâ**
